image: 253882794486.dkr.ecr.us-east-1.amazonaws.com/build-tools:864d3610-node-18

include:
  - project: 'fca/architecture/IaC/cloud-digital/common-ci'
    file: 'job-commons.yml'

stages:
   - test
   - build
 

.rules:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: on_success
      allow_failure: false
    - when: manual

before_script:
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

build-k6:
    stage: build
    extends:
      - .rules
    script: 
      - docker build -t gitlab.fcalatam.com:4567/fca/banco-fidis/ms8/performance-test:latest -f docker/dockerfile .
      - docker push gitlab.fcalatam.com:4567/fca/banco-fidis/ms8/performance-test:latest

payables-load:
  stage: test
  when: manual
  script:
    - docker pull gitlab.fcalatam.com:4567/fca/banco-fidis/ms8/performance-test:latest
    - docker run -t gitlab.fcalatam.com:4567/fca/banco-fidis/ms8/performance-test:latest run --env VARIABLES_ENV=NONPROD --env VU_START=VU_START --env VU_MIDDLE=VU_MIDDLE --env VU_FINAL=VU_FINAL --env DURATION_START=DURATION_START --env DURATION_MIDDLE=DURATION_MIDDLE --env DURATION_FINAL=DURATION_FINAL --env THRESHOLD=THRESHOLD --env FAIL_REQUESTS=FAIL_REQUESTS --env INVOICES=INVOICES dist/sponsors/payables/load.test.js

payables-stress:
  stage: test
  when: manual
  script:
    - docker pull gitlab.fcalatam.com:4567/fca/banco-fidis/ms8/performance-test:latest
    - docker run -t gitlab.fcalatam.com:4567/fca/banco-fidis/ms8/performance-test:latest run --env VARIABLES_ENV=NONPROD --env VU_START=VU_START --env VU_MIDDLE=VU_MIDDLE --env VU_FINAL=VU_FINAL --env DURATION_START=DURATION_START --env DURATION_MIDDLE=DURATION_MIDDLE --env DURATION_FINAL=DURATION_FINAL --env THRESHOLD=THRESHOLD --env FAIL_REQUESTS=FAIL_REQUESTS --env INVOICES=INVOICES dist/sponsors/payables/stress.test.js

submit-orders-load:
  stage: test
  when: manual
  script:
    - docker pull gitlab.fcalatam.com:4567/fca/banco-fidis/ms8/performance-test:latest
    - docker run -t gitlab.fcalatam.com:4567/fca/banco-fidis/ms8/performance-test:latest run --env VARIABLES_ENV=NONPROD --env VU_START=VU_START --env VU_MIDDLE=VU_MIDDLE --env VU_FINAL=VU_FINAL --env DURATION_START=DURATION_START --env DURATION_MIDDLE=DURATION_MIDDLE --env DURATION_FINAL=DURATION_FINAL --env THRESHOLD=THRESHOLD --env FAIL_REQUESTS=FAIL_REQUESTS --env INVOICES=INVOICES dist/operations/orders/load.test.js


submit-orders-stress:
  stage: test
  when: manual
  script:
    - docker pull gitlab.fcalatam.com:4567/fca/banco-fidis/ms8/performance-test:latest
    - docker run -t gitlab.fcalatam.com:4567/fca/banco-fidis/ms8/performance-test:latest run --env VARIABLES_ENV=NONPROD --env VU_START=VU_START --env VU_MIDDLE=VU_MIDDLE --env VU_FINAL=VU_FINAL --env DURATION_START=DURATION_START --env DURATION_MIDDLE=DURATION_MIDDLE --env DURATION_FINAL=DURATION_FINAL --env THRESHOLD=THRESHOLD --env FAIL_REQUESTS=FAIL_REQUESTS --env INVOICES=INVOICES dist/operations/orders/stress.test.js

